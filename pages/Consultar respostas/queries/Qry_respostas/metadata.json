{
  "gitSyncId": "692f23e7862bc92544420b37_13ebb222-bfa3-4f09-8298-f9de3a5a17b1",
  "id": "Consultar respostas_Qry_respostas",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH filtros AS (\n  SELECT\n    sf.id_utilizador,\n    sf.ano,\n    CASE WHEN COALESCE(sf.certificacoes, '') = '' THEN ARRAY[]::text[]\n         ELSE string_to_array(sf.certificacoes, ',')\n    END AS certs\n  FROM selecoes_filtros sf\n  WHERE sf.id_utilizador = {{Select_utilizador.selectedOptionValue}} AND sf.ano = {{Select_year.selectedOptionValue}}\n),\n-- respostas submetidas\nexp AS (\n  SELECT r.id_pergunta, r.id_utilizador, r.ano, r.resposta\n  FROM respostas r\n  WHERE r.id_utilizador = {{Select_utilizador.selectedOptionValue}} AND r.ano = {{Select_year.selectedOptionValue}}\n),\nexp_full AS (\n  SELECT\n    p.id_pergunta,\n    p.pergunta,\n    p.dominio,\n\t\tp.categoria, \n    p.indicador, \n    e.resposta,\n    NULL::text AS \"Certificações aplicáveis\"   -- fica vazio nas respostas submetidas no formulário\n  FROM exp e\n  JOIN perguntas p ON p.id_pergunta = e.id_pergunta\n),\n-- defaults apenas por certificação\ndefaults_base AS (\n  SELECT\n    p.id_pergunta,\n    p.pergunta,\n    p.dominio,\n\t\tp.categoria, \n    p.indicador, \n    'Sim'::text AS resposta,                   -- resposta default das certificacoes: 'Sim'\n    string_agg(DISTINCT c.certificacao, ', ') AS \"Certificações aplicáveis\"  -- coluna que contém os nomes das certificações\n  FROM filtros f\n  JOIN certificacoes c\n    ON c.certificacao = ANY(f.certs)\n  JOIN perguntas p\n    ON p.id_pergunta = c.id_pergunta\n  WHERE NOT EXISTS (SELECT 1 FROM exp e WHERE e.id_pergunta = p.id_pergunta)\n  GROUP BY p.id_pergunta, p.pergunta, p.dominio\n)\nSELECT * FROM exp_full\nUNION ALL\nSELECT * FROM defaults_base\nORDER BY dominio, id_pergunta;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_respostas",
    "pageId": "Consultar respostas",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}