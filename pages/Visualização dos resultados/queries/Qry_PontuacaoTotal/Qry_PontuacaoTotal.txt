WITH per_cat AS (
  SELECT
    r.id_utilizador,
    p.categoria,
    COUNT(*) AS total_perguntas,
    SUM(CASE WHEN r.resposta = 'Yes' THEN 1 ELSE 0 END) AS total_yes,
    CASE
      WHEN SUM(CASE WHEN r.resposta = 'Yes' THEN 1 ELSE 0 END) = 0 THEN 25
      WHEN SUM(CASE WHEN r.resposta = 'Yes' THEN 1 ELSE 0 END) < COUNT(*) THEN 50
      WHEN SUM(CASE WHEN r.resposta = 'Yes' THEN 1 ELSE 0 END) = COUNT(*) THEN 100
    END AS pontuacao
  FROM respostas r
  JOIN perguntas p ON r.id_pergunta = p.id_pergunta
  WHERE r.id_utilizador = {{appsmith.user.email}}
  GROUP BY r.id_utilizador, p.categoria
)
SELECT
  id_utilizador,
  ROUND(AVG(pontuacao)::numeric, 2) AS pontuacao_media   -- average across categories
FROM per_cat
GROUP BY id_utilizador;
