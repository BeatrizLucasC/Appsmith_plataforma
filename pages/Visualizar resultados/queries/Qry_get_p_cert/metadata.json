{
  "gitSyncId": "690b44e5038d962ab21f3367_3df8e886-00f9-4356-bf47-2494833a62cc",
  "id": "Visualizar resultados_Qry_get_p_cert",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH\ntable_certificacoes AS (\n\t\tSELECT DISTINCT\n\t\t\t\tp.codigo,\n\t\t\t\tp.dominio,\n\t\t\t\t--f.certificacao,\n\t\t\t\t--f.sistema_producao,\n\t\t\t\t--f.dimensao,\n\t\t\t\tp.pontuacao_total,\n\t\t\t\tCOUNT(*) AS total_registos\n\t\tFROM fbd_perguntas p\n\t\tJOIN (\n\t\t\t\tSELECT\n\t\t\t\t\t\ttrim(unnest_cert) AS certificacao,\n\t\t\t\t\t\ttrim(unnest_sp) AS sistema_producao,\n\t\t\t\t\t\tu.dimensao\n\t\t\t\tFROM fselecoesfiltros u\n\t\t\t\tCROSS JOIN LATERAL unnest(string_to_array(u.certificacoes, ',')) AS unnest_cert\n\t\t\t\tCROSS JOIN LATERAL unnest(string_to_array(u.sistemas_producao, ',')) AS unnest_sp\n\t\t\t\tWHERE u.utilizador_ano = 'bcardoso@consulai.com_2025'    ------------------------------------Mudar o user!\n\t\t) f ON lower(p.certificacao) = lower(f.certificacao)\n\t\t\t AND lower(p.sistema_producao_sp) = lower(f.sistema_producao)\n\t\tGROUP BY p.dominio,p.codigo,/* f.certificacao, f.sistema_producao, f.dimensao,*/ p.pontuacao_total\n\t\tORDER BY p.dominio,p.codigo),\n\ntable_potencial AS (\n\t\tSELECT DISTINCT\n\t\t\t\tp.codigo,\n\t\t\t\tp.dominio,\n\t\t\t\tf.sistema_producao,\n\t\t\t\tf.dimensao,\n\t\t\t\tp.pontuacao_total,\n\t\t\t\tCOUNT(*) AS total_registos\n\t\tFROM fbd_perguntas p\n\t\tJOIN (\n\t\t\t\tSELECT\n\t\t\t\t\t\ttrim(unnest_sp) AS sistema_producao,\n\t\t\t\t\t\tu.dimensao\n\t\t\t\tFROM fselecoesfiltros u\n\t\t\t\tCROSS JOIN LATERAL unnest(string_to_array(u.sistemas_producao, ',')) AS unnest_sp\n\t\t\t\tWHERE u.utilizador_ano = 'bcardoso@consulai.com_2025') --------------------------Mudar o user!\n\t\t f ON lower(p.sistema_producao_sp) = lower(f.sistema_producao)\n\t\tGROUP BY p.codigo, p.dominio,  f.sistema_producao, f.dimensao, p.pontuacao_total\n\t\tORDER BY p.codigo),\n\ntable_resp AS (\n    SELECT \n        p.\"Domínio\" AS dominio,\n        p.\"Categoria\",\n        p.\"Indicador\",\n        SUM(CASE WHEN r.resposta = 'Sim' THEN p.pontuacao_total ELSE 0 END) AS pontuacao_total\n    FROM alquevasustentavel.frespostas r\n    JOIN alquevasustentavel.\"fPerguntas\" p \n        ON r.id_pergunta = p.\"Código\"\n    GROUP BY p.\"Domínio\", p.\"Categoria\", p.\"Indicador\"\n)\n\n\nSELECT DISTINCT\ndominio,\nSUM(pontuacao_total) AS pontuacao_t_cert,\nROUND(SUM(pontuacao_total)/(SELECT SUM(pontuacao_total) FROM table_potencial)*100,2) AS pontuacao_cert_per\n\nFROM table_certificacoes\nGROUP BY dominio\nORDER BY dominio\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [],
    "name": "Qry_get_p_cert",
    "pageId": "Visualizar resultados",
    "runBehaviour": "ON_PAGE_LOAD",
    "userSetOnLoad": false
  }
}