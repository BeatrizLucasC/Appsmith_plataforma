WITH
table_certificacoes AS (
		SELECT DISTINCT
				p.codigo,
				p.dominio,
				--f.certificacao,
				--f.sistema_producao,
				--f.dimensao,
				p.pontuacao_total,
				COUNT(*) AS total_registos
		FROM fbd_perguntas p
		JOIN (
				SELECT
						trim(unnest_cert) AS certificacao,
						trim(unnest_sp) AS sistema_producao,
						u.dimensao
				FROM fselecoesfiltros u
				CROSS JOIN LATERAL unnest(string_to_array(u.certificacoes, ',')) AS unnest_cert
				CROSS JOIN LATERAL unnest(string_to_array(u.sistemas_producao, ',')) AS unnest_sp
				WHERE u.utilizador_ano = 'bcardoso@consulai.com_2025'    ------------------------------------Mudar o user!
		) f ON lower(p.certificacao) = lower(f.certificacao)
			 AND lower(p.sistema_producao_sp) = lower(f.sistema_producao)
		GROUP BY p.dominio,p.codigo,/* f.certificacao, f.sistema_producao, f.dimensao,*/ p.pontuacao_total
		ORDER BY p.dominio,p.codigo),

table_potencial AS (
		SELECT DISTINCT
				p.codigo,
				p.dominio,
				f.sistema_producao,
				f.dimensao,
				p.pontuacao_total,
				COUNT(*) AS total_registos
		FROM fbd_perguntas p
		JOIN (
				SELECT
						trim(unnest_sp) AS sistema_producao,
						u.dimensao
				FROM fselecoesfiltros u
				CROSS JOIN LATERAL unnest(string_to_array(u.sistemas_producao, ',')) AS unnest_sp
				WHERE u.utilizador_ano = 'bcardoso@consulai.com_2025') --------------------------Mudar o user!
		 f ON lower(p.sistema_producao_sp) = lower(f.sistema_producao)
		GROUP BY p.codigo, p.dominio,  f.sistema_producao, f.dimensao, p.pontuacao_total
		ORDER BY p.codigo),

table_resp AS (
    SELECT 
        p."Domínio" AS dominio,
        p."Categoria",
        p."Indicador",
        SUM(CASE WHEN r.resposta = 'Sim' THEN p.pontuacao_total ELSE 0 END) AS pontuacao_total
    FROM alquevasustentavel.frespostas r
    JOIN alquevasustentavel."fPerguntas" p 
        ON r.id_pergunta = p."Código"
    GROUP BY p."Domínio", p."Categoria", p."Indicador"
)


SELECT DISTINCT
dominio,
SUM(pontuacao_total) AS pontuacao_t_cert,
ROUND(SUM(pontuacao_total)/(SELECT SUM(pontuacao_total) FROM table_potencial)*100,2) AS pontuacao_cert_per

FROM table_certificacoes
GROUP BY dominio
ORDER BY dominio
