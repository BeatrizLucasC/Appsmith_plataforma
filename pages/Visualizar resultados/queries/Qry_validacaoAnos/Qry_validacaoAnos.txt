WITH por_dominio AS (
  SELECT
    ano,
    dominio,
    BOOL_AND(validacao = 'S') AS dominio_validado
  FROM respostas
  WHERE id_utilizador = {{appsmith.user.email}}
    AND dominio IN ('ambiental','social','economico')
  GROUP BY ano, dominio
),
por_ano AS (
  SELECT
    ano,
    COUNT(*) AS dominios_count,
    BOOL_AND(dominio_validado) AS todos_dominios_validados
  FROM por_dominio
  GROUP BY ano
)
SELECT
  ano,
  (dominios_count = 3 AND todos_dominios_validados) AS ano_validado
FROM por_ano
ORDER BY ano DESC;