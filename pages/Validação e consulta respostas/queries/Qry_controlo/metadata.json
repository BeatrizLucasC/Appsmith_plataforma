{
  "gitSyncId": "692f23e7862bc92544420b37_252bf5c0-1393-45ee-8347-e97e1fa11f09",
  "id": "Validação e consulta respostas_Qry_controlo",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH contagens AS (\n  SELECT\n    r.id_utilizador,\n    COUNT(*) AS respostas_total,\n    SUM(CASE WHEN r.validacao = 'S' THEN 1 ELSE 0 END) AS respostas_validadas,\n    SUM(CASE WHEN r.validacao = 'N' THEN 1 ELSE 0 END) AS respostas_nao_validadas,\n    MAX(r.data_hora_submissao) AS ultima_submissao_utc\n  FROM respostas r\n  WHERE r.ano = {{ Select_year.selectedOptionValue }}\n  GROUP BY r.id_utilizador\n),\n\nultima_validacao AS (\n  SELECT DISTINCT ON (r.id_utilizador)\n    r.id_utilizador,\n    r.data_hora_validacao AS ultima_validacao_utc,\n    r.tecnico_validacao\n  FROM respostas r\n  WHERE r.ano = {{ Select_year.selectedOptionValue }}\n    AND r.validacao = 'S'\n    AND r.data_hora_validacao IS NOT NULL\n  ORDER BY r.id_utilizador, r.data_hora_validacao DESC\n),\n\nform_estado AS (\n  SELECT\n    r.id_utilizador,\n    COUNT(*) FILTER (WHERE r.dominio IN ('ambiental','social','economico'))                      AS total_3d,\n    COUNT(*) FILTER (WHERE r.dominio IN ('ambiental','social','economico') AND r.validacao='S')  AS total_validadas_3d,\n    COUNT(DISTINCT r.dominio) FILTER (WHERE r.dominio IN ('ambiental','social','economico'))     AS dominios_respondidos_3d\n  FROM respostas r\n  WHERE r.ano = {{ Select_year.selectedOptionValue }}\n  GROUP BY r.id_utilizador\n)\n\nSELECT\n  COALESCE(u.nome, c.id_utilizador::text) AS nome,\n  c.id_utilizador AS nif,\n\n  -- KPIs\n  c.respostas_total,\n  c.respostas_validadas,\n  c.respostas_nao_validadas,\n\n  -- Última submissão convertida para Europe/Lisbon\n  TO_CHAR(\n    (c.ultima_submissao_utc AT TIME ZONE 'UTC') AT TIME ZONE 'Europe/Lisbon',\n    'DD/MM/YYYY - HH24:MI:SS'\n  ) AS ultima_submissao,\n\n  -- Técnico e data da última validação\n  COALESCE(utech.nome, '—') AS tecnico_validacao_nome,\n  COALESCE(\n    TO_CHAR(\n      (uv.ultima_validacao_utc AT TIME ZONE 'UTC') AT TIME ZONE 'Europe/Lisbon',\n      'DD/MM/YYYY - HH24:MI:SS'\n    ),\n    'Validação pendente'\n  ) AS data_ultima_validacao,\n\n  -- Estado do formulário\n  CASE\n    WHEN fs.dominios_respondidos_3d = 3\n     AND fs.total_3d > 0\n     AND fs.total_3d = fs.total_validadas_3d\n    THEN 'Validado'\n    ELSE 'Por validar'\n  END AS validacao_form\n\nFROM contagens c\nLEFT JOIN utilizadores u\n  ON u.nif = c.id_utilizador\nLEFT JOIN ultima_validacao uv\n  ON uv.id_utilizador = c.id_utilizador\nLEFT JOIN utilizadores utech\n  ON utech.nif = uv.tecnico_validacao\nLEFT JOIN form_estado fs\n  ON fs.id_utilizador = c.id_utilizador\n\nORDER BY\n  c.respostas_validadas DESC,\n  COALESCE(u.nome, c.id_utilizador::text) ASC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": false
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_controlo",
    "pageId": "Validação e consulta respostas",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": true
  }
}