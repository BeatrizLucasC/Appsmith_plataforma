{
  "gitSyncId": "692f23e7862bc92544420b37_4b456254-4890-4e43-add3-a672e7f4d07b",
  "id": "Validação e consulta respostas_Qry_respostasAll",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "\nWITH filtros AS (\n  SELECT\n    sf.id_utilizador,\n    sf.ano,\n    CASE WHEN COALESCE(sf.certificacoes, '') = '' THEN ARRAY[]::text[]\n         ELSE string_to_array(sf.certificacoes, ',')\n    END AS certs\n  FROM selecoes_filtros sf\n  WHERE sf.id_utilizador = {{Tbl_resumo.selectedRow.email}}\n    AND sf.ano = ({{Tbl_resumo.selectedRow.ano}})::int\n),\n\n-- respostas submetidas\nexp AS (\n  SELECT r.id_pergunta, r.id_utilizador, r.ano, r.resposta\n  FROM respostas r\n  WHERE r.id_utilizador = {{Tbl_resumo.selectedRow.email }}\n    AND r.ano = ({{Tbl_resumo.selectedRow.ano }})::int\n),\n\nexp_full AS (\n  SELECT\n    p.id_pergunta,\n    p.pergunta,\n    p.dominio,\n    p.categoria, \n    p.indicador, \n    e.resposta,\n    NULL::text AS \"Certificações aplicáveis\"   -- vazio nas respostas submetidas\n  FROM exp e\n  JOIN perguntas p ON p.id_pergunta = e.id_pergunta\n),\n\n-- defaults apenas por certificação (se não houver resposta submetida para a pergunta)\ndefaults_base AS (\n  SELECT\n    p.id_pergunta,\n    p.pergunta,\n    p.dominio,\n    p.categoria, \n    p.indicador, \n    'Sim'::text AS resposta,  -- default das certificações\n    string_agg(DISTINCT c.certificacao, ', ') AS \"Certificações aplicáveis\"\n  FROM filtros f\n  JOIN certificacoes c\n    ON c.certificacao = ANY(f.certs)\n  JOIN perguntas p\n    ON p.id_pergunta = c.id_pergunta\n  WHERE NOT EXISTS (SELECT 1 FROM exp e WHERE e.id_pergunta = p.id_pergunta)\n  GROUP BY p.id_pergunta, p.pergunta, p.dominio, p.categoria, p.indicador\n)\n\nSELECT * FROM exp_full\nUNION ALL\nSELECT * FROM defaults_base\nORDER BY dominio, id_pergunta;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_respostasAll",
    "pageId": "Validação e consulta respostas",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}