{
  "gitSyncId": "692f23e7862bc92544420b37_f0dfc7d3-8542-45b0-8bc7-6c12ce7f898c",
  "id": "Ranking utilizadores_Qry_dadosIniciais",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH filtros_raw AS (\n  SELECT\n    sf.id_utilizador,\n    sf.ano,\n    sf.data_registo,\n\n    -- certificacoes em CSV -> rótulos legíveis (ignora vazios)\n    array_to_string(\n      ARRAY(\n        SELECT CASE TRIM(val)\n          WHEN 'globalgap' THEN 'GLOBALG.A.P.'\n          WHEN 'grasp'     THEN 'GRASP'\n          WHEN 'spring'    THEN 'SPRING'\n          WHEN 'prodi'     THEN 'PRODI'\n          ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))\n        END\n        FROM unnest(string_to_array(COALESCE(sf.certificacoes, ''), ',')) AS val\n        WHERE TRIM(val) <> ''\n      ),\n      ', '\n    ) AS certificacoes,\n\n    -- sistemas_producao em CSV -> rótulos legíveis (ignora vazios)\n    array_to_string(\n      ARRAY(\n        SELECT CASE TRIM(val)\n          WHEN 'sp_culturas_anuais'       THEN 'Culturas anuais'\n          WHEN 'sp_culturas_permanentes'  THEN 'Culturas permanentes'\n          WHEN 'sp_producao_animal'       THEN 'Produção animal'\n          ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))\n        END\n        FROM unnest(string_to_array(COALESCE(sf.sistemas_producao, ''), ',')) AS val\n        WHERE TRIM(val) <> ''\n      ),\n      ', '\n    ) AS sistemas_producao,\n\n    -- dimensao -> rótulo legível\n    CASE TRIM(COALESCE(sf.dimensao, ''))\n      WHEN 'de_pequena' THEN 'Pequena'\n      WHEN 'de_media'   THEN 'Média'\n      WHEN 'de_grande'  THEN 'Grande'\n      WHEN ''           THEN NULL\n      ELSE INITCAP(REPLACE(TRIM(sf.dimensao), '_', ' '))\n    END AS dimensao\n  FROM selecoes_filtros sf\n  WHERE sf.ano = ({{ Select_year.selectedOptionValue }})::int\n),\n\n-- seleciona a última seleção de filtros por utilizador/ano\nfiltros AS (\n  SELECT DISTINCT ON (fr.id_utilizador, fr.ano)\n    fr.id_utilizador,\n    fr.ano,\n    fr.data_registo,\n    fr.certificacoes,\n    fr.sistemas_producao,\n    fr.dimensao\n  FROM filtros_raw fr\n  ORDER BY fr.id_utilizador, fr.ano, fr.data_registo DESC\n),\n\n-- KPIs por utilizador no ano: apenas S e N\ncontagens AS (\n  SELECT\n    r.id_utilizador,\n    r.ano,\n    COUNT(*) AS respostas_total,\n    SUM(CASE WHEN r.validacao = 'S' THEN 1 ELSE 0 END) AS respostas_validadas,\n    SUM(CASE WHEN r.validacao = 'N' THEN 1 ELSE 0 END) AS respostas_nao_validadas,\n    MAX(r.data_hora_submissao) AS ultima_submissao_utc\n  FROM respostas r\n  WHERE r.ano = ({{ Select_year.selectedOptionValue }})::int\n  GROUP BY r.id_utilizador, r.ano\n)\n\nSELECT\n  u.nome,\n  u.nif,\n  u.email,\n  c.ano,\n\n  -- filtros (podem ser NULL) + formatação de data\n  TO_CHAR(f.data_registo, 'DD/MM/YYYY - HH24:MI:SS') AS data_registo_filtros,\n  f.certificacoes,\n  f.sistemas_producao,\n  f.dimensao,\n\n  -- KPIs\n  c.respostas_total,\n  c.respostas_validadas,          -- 'S'\n  c.respostas_nao_validadas,      -- 'N'\n\n  -- última submissão convertida para Europe/Lisbon + formato DD/MM/AAAA - HH:MM:SS\n  TO_CHAR(\n    (c.ultima_submissao_utc AT TIME ZONE 'UTC') AT TIME ZONE 'Europe/Lisbon',\n    'DD/MM/YYYY - HH24:MI:SS'\n  ) AS ultima_submissao\n\nFROM contagens c\nLEFT JOIN utilizadores u\n  ON u.email = c.id_utilizador\nLEFT JOIN filtros f\n  ON f.id_utilizador = c.id_utilizador AND f.ano = c.ano\n\n-- Ordenar por mais respostas validadas, depois por nome/email\nORDER BY\n  c.respostas_validadas DESC,\n  COALESCE(u.nome, c.id_utilizador) ASC;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "pg_alquevaustentavel",
      "isAutoGenerated": false,
      "name": "pg_alquevaustentavel",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Qry_dadosIniciais",
    "pageId": "Ranking utilizadores",
    "runBehaviour": "ON_PAGE_LOAD",
    "userSetOnLoad": true
  }
}