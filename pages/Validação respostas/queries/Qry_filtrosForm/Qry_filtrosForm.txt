
SELECT
  -- certificacoes em CSV -> mapeadas para rótulos legíveis
  array_to_string(
    ARRAY(
      SELECT CASE TRIM(val)
        WHEN 'globalgap' THEN 'GLOBALG.A.P.'
        WHEN 'grasp'     THEN 'GRASP'
        WHEN 'spring'    THEN 'SPRING'
        WHEN 'prodi'     THEN 'PRODí'
        ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))
      END
      FROM unnest(string_to_array(sf.certificacoes, ',')) AS val
    ),
    ', '
  ) AS certificacoes,

  -- sistemas_producao em CSV -> mapeados
  array_to_string(
    ARRAY(
      SELECT CASE TRIM(val)
        WHEN 'sp_culturas_anuais'       THEN 'Culturas anuais'
        WHEN 'sp_culturas_permanentes'  THEN 'Culturas permanentes'
        WHEN 'sp_producao_animal'       THEN 'Produção animal'
        ELSE INITCAP(REPLACE(TRIM(val), '_', ' '))
      END
      FROM unnest(string_to_array(sf.sistemas_producao, ',')) AS val
    ),
    ', '
  ) AS sistemas_producao,

  -- dimensao -> rótulo legível
  CASE TRIM(sf.dimensao)
    WHEN 'de_pequena' THEN 'Pequena'
    WHEN 'de_media'   THEN 'Média'
    WHEN 'de_grande'  THEN 'Grande'
    ELSE INITCAP(REPLACE(TRIM(sf.dimensao), '_', ' '))
  END AS dimensao

FROM selecoes_filtros sf
WHERE
  sf.id_utilizador = {{Select_utilizador.selectedOptionValue}}
  AND sf.ano = {{Select_year.selectedOptionValue}};
