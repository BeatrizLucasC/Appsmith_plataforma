WITH visiveis AS (
  -- Lê o parâmetro passado e transforma o JSON em linhas (ex.: ["1.1.1.1","1.1.1.2"])
  SELECT value AS id_pergunta
  FROM jsonb_array_elements_text( ({{ this.params.ids_json || '[]' }})::jsonb ) AS t(value)
),
latest AS (
  -- Seleciona a última resposta (não validada) por pergunta, utilizador e ano
  SELECT DISTINCT ON (r.id_pergunta)
    r.id_resposta
  FROM respostas r
  JOIN visiveis v ON v.id_pergunta = r.id_pergunta
  WHERE
    r.id_utilizador = {{ Select_utilizador.selectedOptionValue }}
    AND r.ano = {{ Select_year.selectedOptionValue }}
    AND r.validacao IS NULL
  ORDER BY r.id_pergunta, r.data_hora_submissao DESC
)
UPDATE respostas r
SET validacao = 'S'
WHERE r.id_resposta IN (SELECT id_resposta FROM latest);